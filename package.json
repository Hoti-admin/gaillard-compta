import { prisma } from "@/lib/prisma";
import { notFound } from "next/navigation";
import Link from "next/link";
import { Card, Container, Button, Input, Select, Table, Badge, PageTitle } from "@/components/ui";
import { createBillForSupplier } from "@/app/actions";
import { chf, isoDate } from "@/lib/utils";

type PageProps = {
  params: Promise<{ id: string }> | { id: string };
};

export default async function SupplierDetail(props: PageProps) {
  const params = await Promise.resolve(props.params);
  const id = params?.id;
  if (!id) return notFound();

  const supplier = await prisma.supplier.findUnique({
    where: { id },
    include: {
      bills: {
        include: { payments: true },
        orderBy: { dueDate: "asc" },
      },
    },
  });

  if (!supplier) return notFound();

  return (
    <Container>
      <div className="flex items-start justify-between gap-3">
        <div>
          <PageTitle>{supplier.name}</PageTitle>
          <div className="mt-1 text-sm text-slate-600">
            {supplier.email || "—"} · {supplier.phone || "—"}
          </div>
        </div>

        <Link
          href="/suppliers"
          className="rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm font-semibold text-slate-700 hover:bg-slate-50"
        >
          ← Retour fournisseurs
        </Link>
      </div>

      {/* Création achat fournisseur */}
      <Card className="mt-6">
        <div className="flex items-center justify-between gap-3">
          <div>
            <div className="text-base font-bold text-slate-900">Nouvel achat</div>
            <div className="text-sm text-slate-600">Ajoute une facture fournisseur (achats).</div>
          </div>
        </div>

        <form action={createBillForSupplier} className="mt-4 grid gap-3 md:grid-cols-6">
          <input type="hidden" name="supplierId" value={supplier.id} />

          <div className="md:col-span-2">
            <label className="text-xs font-semibold text-slate-600">N° facture (optionnel)</label>
            <Input name="number" placeholder="ex: F-2026-123" />
          </div>

          <div className="md:col-span-1">
            <label className="text-xs font-semibold text-slate-600">Date</label>
            <Input type="date" name="issueDate" defaultValue={isoDate(new Date())} />
          </div>

          <div className="md:col-span-1">
            <label className="text-xs font-semibold text-slate-600">Échéance</label>
            <Input
              type="date"
              name="dueDate"
              defaultValue={isoDate(new Date(Date.now() + 30 * 24 * 3600 * 1000))}
            />
          </div>

          <div className="md:col-span-1">
            <label className="text-xs font-semibold text-slate-600">TTC (CHF)</label>
            <Input name="totalTtc" inputMode="decimal" placeholder="0.00" />
          </div>

          <div className="md:col-span-1">
            <label className="text-xs font-semibold text-slate-600">TVA %</label>
            <Input name="vatRate" inputMode="decimal" defaultValue="8.1" />
          </div>

          <div className="md:col-span-6">
            <label className="text-xs font-semibold text-slate-600">Note (optionnel)</label>
            <Input name="notes" placeholder="ex: Peinture, outillage, etc." />
          </div>

          <div className="md:col-span-6 flex justify-end">
            <Button type="submit">Ajouter l’achat</Button>
          </div>
        </form>
      </Card>

      {/* Liste achats */}
      <Card className="mt-6">
        <div className="flex items-center justify-between gap-3">
          <div>
            <div className="text-base font-bold text-slate-900">Achats</div>
            <div className="text-sm text-slate-600">Factures fournisseur & paiements.</div>
          </div>
        </div>

        {supplier.bills.length === 0 ? (
          <div className="mt-4 text-sm text-slate-600">Aucun achat pour ce fournisseur.</div>
        ) : (
          <div className="mt-4 overflow-x-auto">
            <Table
              headers={["N°", "Date", "Échéance", "TTC", "Payé", "Solde", "Statut"]}
              rows={supplier.bills.map((b) => {
                const paid = b.payments.reduce((s, p) => s + p.amountCents, 0);
                const balance = b.amountGrossCents - paid;

                const status =
                  balance <= 0 ? "PAID" : paid > 0 ? "PARTIAL" : "OPEN";

                return [
                  b.number || "—",
                  new Date(b.issueDate).toLocaleDateString(),
                  new Date(b.dueDate).toLocaleDateString(),
                  chf(b.amountGrossCents),
                  chf(paid),
                  chf(balance),
                  <Badge
                    key={b.id}
                    tone={status === "PAID" ? "success" : status === "PARTIAL" ? "warning" : "neutral"}
                  >
                    {status}
                  </Badge>,
                ];
              })}
            />
          </div>
        )}
      </Card>
    </Container>
  );
}
